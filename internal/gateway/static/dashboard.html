<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CC Gateway ‚Äî Admin Dashboard</title>
<style>
  :root {
    --bg: #0f1117; --surface: #1a1d2e; --surface2: #242840;
    --border: #2e3354; --text: #e1e4f0; --text2: #8b90b0;
    --accent: #6c5ce7; --accent2: #a29bfe; --green: #00cec9;
    --red: #ff6b6b; --orange: #ffa502; --blue: #74b9ff;
    --radius: 12px; --shadow: 0 4px 24px rgba(0,0,0,.35);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Inter','SF Pro',system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
  a { color:var(--accent2); text-decoration:none; }

  /* Layout */
  .app { display:flex; min-height:100vh; }
  .sidebar { width:220px; background:var(--surface); border-right:1px solid var(--border); padding:24px 0; flex-shrink:0; position:fixed; top:0; left:0; bottom:0; overflow-y:auto; z-index:10; }
  .sidebar h1 { font-size:16px; font-weight:700; padding:0 20px 20px; color:var(--accent2); letter-spacing:.5px; }
  .sidebar .version { font-size:11px; color:var(--text2); display:block; padding:0 20px; margin-top:-14px; margin-bottom:16px; }
  .nav-item { display:flex; align-items:center; gap:10px; padding:10px 20px; cursor:pointer; color:var(--text2); font-size:14px; transition:all .2s; border-left:3px solid transparent; }
  .nav-item:hover { background:var(--surface2); color:var(--text); }
  .nav-item.active { color:var(--accent2); background:rgba(108,92,231,.1); border-left-color:var(--accent); }
  .nav-item .icon { width:18px; text-align:center; font-size:15px; }
  .main { margin-left:220px; flex:1; padding:28px 32px; }

  /* Header */
  .page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
  .page-header h2 { font-size:22px; font-weight:600; }
  .badge { display:inline-block; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:600; }
  .badge-green { background:rgba(0,206,201,.15); color:var(--green); }
  .badge-red { background:rgba(255,107,107,.15); color:var(--red); }
  .badge-orange { background:rgba(255,165,2,.15); color:var(--orange); }

  /* Cards */
  .cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:16px; margin-bottom:28px; }
  .card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:20px; transition:transform .2s,box-shadow .2s; }
  .card:hover { transform:translateY(-2px); box-shadow:var(--shadow); }
  .card .label { font-size:12px; color:var(--text2); text-transform:uppercase; letter-spacing:.8px; margin-bottom:8px; }
  .card .value { font-size:28px; font-weight:700; }
  .card .sub { font-size:12px; color:var(--text2); margin-top:4px; }

  /* Table */
  .panel { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:24px; overflow:hidden; }
  .panel-head { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
  .panel-head h3 { font-size:15px; font-weight:600; }
  table { width:100%; border-collapse:collapse; }
  th,td { padding:10px 20px; text-align:left; font-size:13px; }
  th { color:var(--text2); font-weight:500; text-transform:uppercase; letter-spacing:.5px; font-size:11px; border-bottom:1px solid var(--border); }
  tr:not(:last-child) td { border-bottom:1px solid rgba(46,51,84,.5); }
  tr:hover td { background:rgba(108,92,231,.04); }

  /* Forms */
  .form-group { margin-bottom:16px; }
  .form-group label { display:block; font-size:12px; color:var(--text2); margin-bottom:6px; text-transform:uppercase; letter-spacing:.5px; }
  input[type="text"],input[type="number"],select,textarea { width:100%; padding:10px 14px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:13px; outline:none; transition:border-color .2s; }
  input:focus,select:focus,textarea:focus { border-color:var(--accent); }
  textarea { resize:vertical; min-height:80px; font-family:monospace; }

  /* Buttons */
  .btn { padding:8px 18px; border-radius:8px; border:none; font-size:13px; font-weight:600; cursor:pointer; transition:all .2s; }
  .btn-primary { background:var(--accent); color:#fff; }
  .btn-primary:hover { background:var(--accent2); }
  .btn-danger { background:var(--red); color:#fff; }
  .btn-danger:hover { opacity:.85; }
  .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text); }
  .btn-outline:hover { border-color:var(--accent); color:var(--accent2); }
  .btn-sm { padding:5px 12px; font-size:12px; }

  /* Toggle */
  .toggle { position:relative; width:44px; height:24px; cursor:pointer; }
  .toggle input { display:none; }
  .toggle .slider { position:absolute; inset:0; background:var(--surface2); border-radius:12px; border:1px solid var(--border); transition:.3s; }
  .toggle .slider:before { content:''; position:absolute; width:18px; height:18px; left:2px; top:2px; background:var(--text2); border-radius:50%; transition:.3s; }
  .toggle input:checked+.slider { background:var(--accent); border-color:var(--accent); }
  .toggle input:checked+.slider:before { transform:translateX(20px); background:#fff; }

  /* Status dot */
  .dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px; }
  .dot-green { background:var(--green); box-shadow:0 0 6px var(--green); }
  .dot-red { background:var(--red); box-shadow:0 0 6px var(--red); }
  .dot-orange { background:var(--orange); }

  /* Toast */
  .toast { position:fixed; top:20px; right:20px; padding:12px 20px; border-radius:8px; font-size:13px; font-weight:500; z-index:100; opacity:0; transform:translateY(-10px); transition:all .3s; pointer-events:none; }
  .toast.show { opacity:1; transform:translateY(0); }
  .toast-ok { background:rgba(0,206,201,.9); color:#fff; }
  .toast-err { background:rgba(255,107,107,.9); color:#fff; }

  /* Sections */
  .section { display:none; }
  .section.active { display:block; }

  /* JSON editor */
  .json-editor { font-family:'JetBrains Mono','Fira Code',monospace; font-size:12px; min-height:200px; }

  /* Responsive */
  @media(max-width:768px) {
    .sidebar { width:60px; } .sidebar h1,.sidebar .version,.nav-item span:not(.icon) { display:none; }
    .main { margin-left:60px; padding:16px; }
    .cards { grid-template-columns:1fr; }
  }

  /* Animations */
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  .section.active { animation:fadeIn .3s ease; }
  .loading { display:inline-block; width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .6s linear infinite; }
  @keyframes spin { to{transform:rotate(360deg)} }
</style>
</head>
<body>
<div class="app">
  <nav class="sidebar">
    <h1>‚ö° CC Gateway</h1>
    <span class="version">Admin Dashboard</span>
    <div class="nav-item active" data-tab="overview"><span class="icon">üìä</span><span>Overview</span></div>
    <div class="nav-item" data-tab="settings"><span class="icon">‚öôÔ∏è</span><span>Settings</span></div>
    <div class="nav-item" data-tab="models"><span class="icon">ü§ñ</span><span>Models</span></div>
    <div class="nav-item" data-tab="tools"><span class="icon">üß∞</span><span>Tools</span></div>
    <div class="nav-item" data-tab="plugins"><span class="icon">üß©</span><span>Plugins</span></div>
    <div class="nav-item" data-tab="mcp"><span class="icon">üîå</span><span>MCP</span></div>
    <div class="nav-item" data-tab="teams"><span class="icon">üë•</span><span>Agent Teams</span></div>
    <div class="nav-item" data-tab="subagents"><span class="icon">ü§ù</span><span>Subagents</span></div>
    <div class="nav-item" data-tab="events"><span class="icon">üì°</span><span>Events</span></div>
    <div class="nav-item" data-tab="todos"><span class="icon">‚úÖ</span><span>Todos</span></div>
    <div class="nav-item" data-tab="plans"><span class="icon">üó∫Ô∏è</span><span>Plans</span></div>
    <div class="nav-item" data-tab="skills"><span class="icon">‚ú®</span><span>Skills</span></div>
    <div class="nav-item" data-tab="rules"><span class="icon">üìú</span><span>Rules</span></div>
    <div class="nav-item" data-tab="cost"><span class="icon">üí∞</span><span>Cost</span></div>
    <div class="nav-item" data-tab="eval"><span class="icon">üß†</span><span>Eval</span></div>
  </nav>
  <main class="main">
    <!-- OVERVIEW -->
    <section id="sec-overview" class="section active">
      <div class="page-header"><h2>System Overview</h2><span class="badge badge-green" id="health-badge">‚óè Healthy</span></div>
      <div class="cards" id="overview-cards"></div>
      <div class="panel">
        <div class="panel-head"><h3>Adapter Status</h3><button class="btn btn-outline btn-sm" onclick="loadScheduler()">Refresh</button></div>
        <table><thead><tr><th>Adapter</th><th>Status</th><th>Model</th><th>Requests</th><th>Failures</th></tr></thead><tbody id="adapter-tbody"></tbody></table>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="sec-settings" class="section">
      <div class="page-header"><h2>Runtime Settings</h2><button class="btn btn-primary" onclick="saveSettings()">Save Changes</button></div>
      <div class="panel" style="padding:20px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div class="form-group"><label>Reflection Passes</label><input type="number" id="set-reflection" min="0" max="5"></div>
          <div class="form-group"><label>Timeout (ms)</label><input type="number" id="set-timeout" min="1000" max="120000"></div>
          <div class="form-group"><label>Parallel Candidates</label><input type="number" id="set-candidates" min="1" max="10"></div>
          <div class="form-group"><label>Max Retries</label><input type="number" id="set-retries" min="0" max="10"></div>
          <div class="form-group"><label>Tool Loop Mode</label>
            <select id="set-toolmode"><option value="client_loop">Client Loop</option><option value="server_loop">Server Loop</option></select>
          </div>
          <div class="form-group"><label>Tool Loop Max Steps</label><input type="number" id="set-maxsteps" min="1" max="50"></div>
          <div class="form-group" style="display:flex;align-items:center;gap:12px;margin-top:20px">
            <label style="margin:0">Enable Response Judge</label>
            <label class="toggle"><input type="checkbox" id="set-judge"><span class="slider"></span></label>
          </div>
          <div class="form-group" style="display:flex;align-items:center;gap:12px;margin-top:20px">
            <label style="margin:0">Allow Experimental Tools</label>
            <label class="toggle"><input type="checkbox" id="set-experimental"><span class="slider"></span></label>
          </div>
        </div>
        <div class="form-group" style="margin-top:20px"><label>Mode ‚Üí Model Overrides (JSON)</label><textarea class="json-editor" id="set-mode-models"></textarea></div>
        <div class="form-group"><label>Runtime Model Mappings (JSON)</label><textarea class="json-editor" id="set-model-mappings"></textarea></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div class="form-group" style="display:flex;align-items:center;gap:12px;margin-top:8px">
            <label style="margin:0">Model Mapping Strict</label>
            <label class="toggle"><input type="checkbox" id="set-model-map-strict"><span class="slider"></span></label>
          </div>
          <div class="form-group"><label>Model Mapping Fallback</label><input type="text" id="set-model-map-fallback" placeholder="fallback-model"></div>
        </div>
        <div class="form-group"><label>Prompt Prefixes (JSON)</label><textarea class="json-editor" id="set-prompts"></textarea></div>
        <div class="form-group"><label>Mode Routes (JSON)</label><textarea class="json-editor" id="set-routes"></textarea></div>
      </div>
    </section>

    <!-- MODELS -->
    <section id="sec-models" class="section">
      <div class="page-header"><h2>Model Routing</h2></div>
      <div class="cards" id="model-cards"></div>
      <div class="panel">
        <div class="panel-head"><h3>Active Mode Routes</h3></div>
        <table><thead><tr><th>Mode</th><th>Model Chain</th></tr></thead><tbody id="route-tbody"></tbody></table>
      </div>
      <div class="panel" style="padding:20px">
        <div class="panel-head" style="padding:0 0 12px 0;border-bottom:none">
          <h3>Upstream Adapters (JSON)</h3>
          <div style="display:flex;gap:8px">
            <button class="btn btn-outline btn-sm" onclick="loadUpstreamAdmin()">Refresh</button>
            <button class="btn btn-primary btn-sm" onclick="saveUpstreamAdmin()">Apply</button>
          </div>
        </div>
        <textarea id="upstream-admin-json" class="json-editor" style="min-height:220px"></textarea>
      </div>
    </section>

    <!-- TOOLS -->
    <section id="sec-tools" class="section">
      <div class="page-header"><h2>Tool Catalog</h2><button class="btn btn-outline btn-sm" onclick="loadTools()">Refresh</button></div>
      <div class="panel">
        <table><thead><tr><th>Name</th><th>Category</th><th>Status</th></tr></thead><tbody id="tools-tbody"></tbody></table>
      </div>
    </section>

    <!-- PLUGINS -->
    <section id="sec-plugins" class="section">
      <div class="page-header"><h2>Plugin Center</h2><button class="btn btn-outline btn-sm" onclick="loadPlugins()">Refresh</button></div>
      <div class="panel" style="padding:20px">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          <div class="form-group"><label>Name</label><input type="text" id="plugin-name" placeholder="planner_pack"></div>
          <div class="form-group"><label>Version</label><input type="text" id="plugin-version" placeholder="1.0.0"></div>
          <div class="form-group"><label>Description</label><input type="text" id="plugin-desc" placeholder="High-level planning and reflection bundle"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          <div class="form-group"><label>Skills (JSON array)</label><textarea id="plugin-skills" style="min-height:90px">[]</textarea></div>
          <div class="form-group"><label>Hooks (JSON array)</label><textarea id="plugin-hooks" style="min-height:90px">[]</textarea></div>
          <div class="form-group"><label>MCP Servers (JSON array)</label><textarea id="plugin-mcp" style="min-height:90px">[]</textarea></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="installPlugin()">Install Plugin</button>
          <button class="btn btn-outline" onclick="loadPlugins()">Reload</button>
        </div>
      </div>
      <div class="panel">
        <table><thead><tr><th>Name</th><th>Version</th><th>Status</th><th>Skills</th><th>Hooks</th><th>MCP</th><th>Actions</th></tr></thead><tbody id="plugin-tbody"></tbody></table>
      </div>
      <div class="panel" style="padding:20px">
        <div class="panel-head" style="padding:0 0 12px 0;border-bottom:none"><h3>Plugin Detail</h3></div>
        <textarea id="plugin-preview" class="json-editor" style="min-height:140px" readonly></textarea>
      </div>
    </section>

    <!-- MCP -->
    <section id="sec-mcp" class="section">
      <div class="page-header"><h2>MCP Servers</h2><button class="btn btn-outline btn-sm" onclick="loadMCPServers()">Refresh</button></div>
      <div class="panel" style="padding:20px">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          <div class="form-group"><label>Server ID (optional)</label><input type="text" id="mcp-id" placeholder="mcp_local"></div>
          <div class="form-group"><label>Name</label><input type="text" id="mcp-name" placeholder="Local MCP"></div>
          <div class="form-group"><label>Transport</label><select id="mcp-transport"><option value="http">http</option><option value="stdio">stdio</option></select></div>
          <div class="form-group"><label>URL (http)</label><input type="text" id="mcp-url" placeholder="http://127.0.0.1:18080/mcp"></div>
          <div class="form-group"><label>Command (stdio)</label><input type="text" id="mcp-command" placeholder="npx -y @modelcontextprotocol/server-filesystem"></div>
          <div class="form-group"><label>Args (JSON array)</label><input type="text" id="mcp-args" placeholder='["/tmp"]'></div>
          <div class="form-group"><label>Timeout (ms)</label><input type="number" id="mcp-timeout" value="15000" min="1000"></div>
          <div class="form-group"><label>Retries</label><input type="number" id="mcp-retries" value="1" min="0"></div>
        </div>
        <div style="display:flex;gap:8px"><button class="btn btn-primary" onclick="registerMCPServer()">Register MCP</button></div>
      </div>
      <div class="panel">
        <table><thead><tr><th>ID</th><th>Name</th><th>Transport</th><th>Endpoint</th><th>Status</th><th>Actions</th></tr></thead><tbody id="mcp-tbody"></tbody></table>
      </div>
      <div class="panel" style="padding:20px">
        <div class="panel-head" style="padding:0 0 12px 0;border-bottom:none"><h3>MCP Tools Preview</h3></div>
        <textarea id="mcp-tools-preview" class="json-editor" style="min-height:140px" readonly></textarea>
      </div>
    </section>

    <!-- AGENT TEAMS -->
    <section id="sec-teams" class="section">
      <div class="page-header"><h2>Agent Teams</h2><button class="btn btn-outline btn-sm" onclick="loadTeams()">Refresh</button></div>
      <div class="panel" style="padding:20px">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
          <div class="form-group"><label>Team ID</label><input type="text" id="team-create-id" placeholder="team_alpha"></div>
          <div class="form-group"><label>Team Name</label><input type="text" id="team-create-name" placeholder="Alpha Team"></div>
          <div class="form-group"><label>Lead Agent ID</label><input type="text" id="team-create-lead" placeholder="lead_alpha"></div>
          <div class="form-group"><label>Lead Model</label><input type="text" id="team-create-model" placeholder="gpt-4o"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="createTeam()">Create Team</button>
          <button class="btn btn-outline" onclick="loadTeams()">Reload Teams</button>
        </div>
      </div>
      <div class="panel">
        <table><thead><tr><th>ID</th><th>Name</th><th>Agents</th><th>Tasks</th><th>Actions</th></tr></thead><tbody id="team-tbody"></tbody></table>
      </div>
      <div class="panel" style="padding:20px">
        <div class="panel-head" style="padding:0 0 12px 0;border-bottom:none"><h3>Task Board Actions</h3></div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
          <div class="form-group"><label>Team ID</label><input type="text" id="team-task-team" placeholder="team_alpha"></div>
          <div class="form-group"><label>Task Title</label><input type="text" id="team-task-title" placeholder="Split work"></div>
          <div class="form-group"><label>Assigned To</label><input type="text" id="team-task-assigned" placeholder="lead_alpha"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="createTeamTask()">Add Task</button>
          <button class="btn btn-outline" onclick="orchestrateTeam()">Orchestrate Team</button>
          <button class="btn btn-outline" onclick="loadTeamTasks()">Load Tasks</button>
        </div>
        <textarea id="team-task-result" class="json-editor" style="min-height:140px;margin-top:12px" readonly></textarea>
      </div>
    </section>

    <!-- SUBAGENTS -->
    <section id="sec-subagents" class="section">
      <div class="page-header"><h2>Subagents</h2><button class="btn btn-outline btn-sm" onclick="loadSubagents()">Refresh</button></div>
      <div class="panel" style="padding:20px">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
          <div class="form-group"><label>Parent/Team ID</label><input type="text" id="sub-filter-parent" placeholder="team_alpha"></div>
          <div class="form-group"><label>Status</label><input type="text" id="sub-filter-status" placeholder="running/completed"></div>
          <div class="form-group"><label>Model</label><input type="text" id="sub-filter-model" placeholder="gpt-4o"></div>
          <div class="form-group"><label>Include Deleted</label><select id="sub-filter-deleted"><option value="false">false</option><option value="true">true</option></select></div>
        </div>
      </div>
      <div class="panel">
        <table><thead><tr><th>ID</th><th>Parent</th><th>Status</th><th>Model</th><th>Actions</th></tr></thead><tbody id="subagent-tbody"></tbody></table>
      </div>
      <div class="panel" style="padding:20px">
        <div class="panel-head" style="padding:0 0 12px 0;border-bottom:none"><h3>Subagent Timeline</h3></div>
        <textarea id="subagent-timeline" class="json-editor" style="min-height:160px" readonly></textarea>
      </div>
    </section>

    <!-- EVENTS -->
    <section id="sec-events" class="section">
      <div class="page-header"><h2>Event Stream & Logs</h2><button class="btn btn-outline btn-sm" onclick="loadEvents()">Refresh</button></div>
      <div class="panel" style="padding:20px">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
          <div class="form-group"><label>event_type</label><input type="text" id="evt-type" placeholder="team.task.completed"></div>
          <div class="form-group"><label>session_id</label><input type="text" id="evt-session" placeholder="sess_xxx"></div>
          <div class="form-group"><label>run_id</label><input type="text" id="evt-run" placeholder="run_xxx"></div>
          <div class="form-group"><label>plan_id</label><input type="text" id="evt-plan" placeholder="plan_xxx"></div>
          <div class="form-group"><label>todo_id</label><input type="text" id="evt-todo" placeholder="todo_xxx"></div>
          <div class="form-group"><label>team_id</label><input type="text" id="evt-team" placeholder="team_alpha"></div>
          <div class="form-group"><label>subagent_id</label><input type="text" id="evt-subagent" placeholder="agent_xxx"></div>
          <div class="form-group"><label>limit</label><input type="number" id="evt-limit" value="100" min="1" max="500"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="loadEvents()">Load Events</button>
          <button class="btn btn-outline" onclick="startEventStream()">Start SSE</button>
          <button class="btn btn-danger" onclick="stopEventStream()">Stop SSE</button>
        </div>
      </div>
      <div class="panel">
        <table><thead><tr><th>Time</th><th>Type</th><th>Team</th><th>Subagent</th><th>Record</th></tr></thead><tbody id="event-tbody"></tbody></table>
      </div>
    </section>

    <!-- TODOS -->
    <section id="sec-todos" class="section">
      <div class="page-header"><h2>Todo Board</h2><button class="btn btn-outline btn-sm" onclick="loadTodos()">Refresh</button></div>
      <div class="panel" style="padding:20px">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
          <div class="form-group"><label>Todo ID (optional)</label><input type="text" id="todo-id" placeholder="todo_custom_1"></div>
          <div class="form-group"><label>Title</label><input type="text" id="todo-title" placeholder="Run reflection pass"></div>
          <div class="form-group"><label>Status</label><select id="todo-status"><option value="pending">pending</option><option value="in_progress">in_progress</option><option value="completed">completed</option><option value="blocked">blocked</option><option value="canceled">canceled</option></select></div>
          <div class="form-group"><label>Plan ID</label><input type="text" id="todo-plan-id" placeholder="plan_xxx"></div>
          <div class="form-group"><label>Session ID</label><input type="text" id="todo-session-id" placeholder="sess_xxx"></div>
          <div class="form-group"><label>Run ID</label><input type="text" id="todo-run-id" placeholder="run_xxx"></div>
          <div class="form-group" style="grid-column:span 2"><label>Description</label><input type="text" id="todo-desc" placeholder="todo detail"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="createTodo()">Create Todo</button>
          <button class="btn btn-outline" onclick="loadTodos()">Reload Todos</button>
        </div>
      </div>
      <div class="panel" style="padding:20px">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
          <div class="form-group"><label>Filter status</label><input type="text" id="todo-filter-status" placeholder="completed"></div>
          <div class="form-group"><label>Filter plan_id</label><input type="text" id="todo-filter-plan" placeholder="plan_xxx"></div>
          <div class="form-group"><label>Filter session_id</label><input type="text" id="todo-filter-session" placeholder="sess_xxx"></div>
          <div class="form-group"><label>Limit</label><input type="number" id="todo-filter-limit" value="100" min="1" max="500"></div>
        </div>
      </div>
      <div class="panel">
        <table><thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Plan</th><th>Session</th><th>Actions</th></tr></thead><tbody id="todo-tbody"></tbody></table>
      </div>
      <div class="panel" style="padding:20px">
        <div class="panel-head" style="padding:0 0 12px 0;border-bottom:none"><h3>Todo Detail</h3></div>
        <textarea id="todo-preview" class="json-editor" style="min-height:140px" readonly></textarea>
      </div>
    </section>

    <!-- PLANS -->
    <section id="sec-plans" class="section">
      <div class="page-header"><h2>Plan Orchestration</h2><button class="btn btn-outline btn-sm" onclick="loadPlans()">Refresh</button></div>
      <div class="panel" style="padding:20px">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
          <div class="form-group"><label>Plan ID (optional)</label><input type="text" id="plan-id" placeholder="plan_custom_1"></div>
          <div class="form-group"><label>Title</label><input type="text" id="plan-title" placeholder="High-concurrency execution plan"></div>
          <div class="form-group"><label>Session ID</label><input type="text" id="plan-session-id" placeholder="sess_xxx"></div>
          <div class="form-group"><label>Run ID</label><input type="text" id="plan-run-id" placeholder="run_xxx"></div>
        </div>
        <div class="form-group"><label>Summary</label><input type="text" id="plan-summary" placeholder="Plan summary"></div>
        <div class="form-group"><label>Steps (one line per step, use `title | description` format)</label><textarea id="plan-steps" style="min-height:100px" placeholder="Analyze request | classify complexity&#10;Dispatch workers | parallel execute&#10;Reflect & calibrate | finalize response"></textarea></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="createPlan()">Create Plan</button>
          <button class="btn btn-outline" onclick="loadPlans()">Reload Plans</button>
        </div>
      </div>
      <div class="panel" style="padding:20px">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
          <div class="form-group"><label>Filter status</label><input type="text" id="plan-filter-status" placeholder="approved/executing"></div>
          <div class="form-group"><label>Filter session_id</label><input type="text" id="plan-filter-session" placeholder="sess_xxx"></div>
          <div class="form-group"><label>Filter run_id</label><input type="text" id="plan-filter-run" placeholder="run_xxx"></div>
          <div class="form-group"><label>Limit</label><input type="number" id="plan-filter-limit" value="100" min="1" max="500"></div>
        </div>
      </div>
      <div class="panel">
        <table><thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Steps</th><th>Actions</th></tr></thead><tbody id="plan-tbody"></tbody></table>
      </div>
      <div class="panel" style="padding:20px">
        <div class="panel-head" style="padding:0 0 12px 0;border-bottom:none"><h3>Plan Detail</h3></div>
        <textarea id="plan-preview" class="json-editor" style="min-height:140px" readonly></textarea>
      </div>
    </section>

    <!-- SKILLS -->
    <section id="sec-skills" class="section">
      <div class="page-header"><h2>Skill Engine</h2><button class="btn btn-primary" onclick="showSkillForm()">+ Register Skill</button></div>
      <div class="panel" id="skill-form-panel" style="display:none;padding:20px;margin-bottom:16px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="form-group"><label>Name</label><input type="text" id="skill-name" placeholder="my_skill"></div>
          <div class="form-group"><label>Description</label><input type="text" id="skill-desc" placeholder="What this skill does"></div>
        </div>
        <div class="form-group"><label>Template</label><textarea id="skill-template" placeholder="Hello {{name}}, your task is {{task}}"></textarea></div>
        <div class="form-group"><label>Parameters (JSON, e.g. {"name":"default_val"})</label><textarea id="skill-params" style="min-height:60px">{}</textarea></div>
        <div style="display:flex;gap:8px"><button class="btn btn-primary" onclick="registerSkill()">Register</button><button class="btn btn-outline" onclick="hideSkillForm()">Cancel</button></div>
      </div>
      <div class="panel">
        <table><thead><tr><th>Name</th><th>Description</th><th>Params</th><th>Actions</th></tr></thead><tbody id="skills-tbody"></tbody></table>
      </div>
    </section>

    <!-- RULES -->
    <section id="sec-rules" class="section">
      <div class="page-header"><h2>Rules DSL</h2><button class="btn btn-primary" onclick="showRuleForm()">+ Add Rule</button></div>
      <div class="panel" id="rule-form-panel" style="display:none;padding:20px;margin-bottom:16px">
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px">
          <div class="form-group"><label>Name</label><input type="text" id="rule-name" placeholder="rule_name"></div>
          <div class="form-group"><label>Pattern (glob)</label><input type="text" id="rule-pattern" placeholder="*.go"></div>
          <div class="form-group"><label>Action</label><select id="rule-action"><option value="allow">Allow</option><option value="ask">Ask</option><option value="deny">Deny</option></select></div>
          <div class="form-group"><label>Priority</label><input type="number" id="rule-priority" value="0" min="-100" max="100"></div>
        </div>
        <div class="form-group"><label>Scope</label><input type="text" id="rule-scope" placeholder="global"></div>
        <div style="display:flex;gap:8px"><button class="btn btn-primary" onclick="addRule()">Add Rule</button><button class="btn btn-outline" onclick="hideRuleForm()">Cancel</button></div>
      </div>
      <div class="panel">
        <table><thead><tr><th>Name</th><th>Pattern</th><th>Action</th><th>Priority</th><th>Scope</th><th>Actions</th></tr></thead><tbody id="rules-tbody"></tbody></table>
      </div>
    </section>

    <!-- COST -->
    <section id="sec-cost" class="section">
      <div class="page-header"><h2>Cost Tracking</h2><button class="btn btn-outline btn-sm" onclick="loadCost()">Refresh</button></div>
      <div class="cards" id="cost-cards"></div>
      <div class="panel">
        <div class="panel-head"><h3>Per-Model Breakdown</h3></div>
        <table><thead><tr><th>Model</th><th>Requests</th><th>Input Tokens</th><th>Output Tokens</th><th>Cost (USD)</th></tr></thead><tbody id="cost-tbody"></tbody></table>
      </div>
    </section>

    <!-- EVAL -->
    <section id="sec-eval" class="section">
      <div class="page-header"><h2>Intelligence Evaluation</h2><button class="btn btn-primary" onclick="runEval()">Run Evaluation</button></div>
      <div class="panel" style="padding:20px">
        <div class="form-group"><label>Model</label><input type="text" id="eval-model" placeholder="Model to evaluate (e.g. claude-3.5-sonnet)"></div>
        <div class="form-group"><label>Prompt</label><textarea id="eval-prompt" placeholder="Enter a test prompt to evaluate..."></textarea></div>
        <div class="form-group"><label>Response (leave empty to auto-generate)</label><textarea id="eval-response" placeholder="Paste the model's response, or leave empty"></textarea></div>
      </div>
      <div id="eval-results" style="display:none">
        <div class="cards" id="eval-cards"></div>
        <div class="panel" style="padding:20px"><h3 style="margin-bottom:12px">Analysis</h3><div id="eval-analysis" style="white-space:pre-wrap;font-size:13px;color:var(--text2);line-height:1.6"></div></div>
      </div>
    </section>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
const BASE = '';
const adminToken = localStorage.getItem('cc_admin_token') || '';
const headers = ()=>{ const h={'Content-Type':'application/json'}; if(adminToken) h['x-admin-token']=adminToken; return h; };

// Navigation
document.querySelectorAll('.nav-item').forEach(el=>{
  el.addEventListener('click',()=>{
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('sec-'+el.dataset.tab).classList.add('active');
    const loaders = {
      overview: loadOverview,
      settings: loadSettings,
      models: loadModels,
      tools: loadTools,
      plugins: loadPlugins,
      mcp: loadMCPServers,
      teams: loadTeams,
      subagents: loadSubagents,
      events: loadEvents,
      todos: loadTodos,
      plans: loadPlans,
      skills: loadSkills,
      rules: loadRules,
      cost: loadCost,
    };
    if(loaders[el.dataset.tab]) loaders[el.dataset.tab]();
  });
});

function toast(msg,ok=true){ const t=document.getElementById('toast'); t.className='toast '+(ok?'toast-ok':'toast-err')+' show'; t.textContent=msg; setTimeout(()=>t.classList.remove('show'),3000); }

async function api(path,opts={}){
  try{
    const r=await fetch(BASE+path,{headers:headers(),...opts});
    if(!r.ok) throw new Error(await r.text());
    if(r.status===204) return {};
    return r.json();
  }catch(e){ toast(e.message,false); throw e; }
}

// OVERVIEW
async function loadOverview(){
  try{
    const [health,settings,sched]=await Promise.all([
      fetch(BASE+'/healthz').then(r=>r.json()).catch(()=>({ok:false})),
      api('/admin/settings').catch(()=>({})),
      api('/admin/scheduler').catch(()=>({scheduler:{}}))
    ]);
    const b=document.getElementById('health-badge');
    b.textContent=health.ok?'‚óè Healthy':'‚óè Unhealthy';
    b.className='badge '+(health.ok?'badge-green':'badge-red');

    const s=settings||{};
    const cards=[
      {label:'Reflection Passes',value:s.routing?.reflection_passes||1,sub:'per request'},
      {label:'Parallel Candidates',value:s.routing?.parallel_candidates||1,sub:'per request'},
      {label:'Tool Loop',value:s.tool_loop?.mode||'client_loop',sub:'max '+( s.tool_loop?.max_steps||4)+' steps'},
      {label:'Timeout',value:((s.routing?.timeout_ms||30000)/1000)+'s',sub:'per upstream call'},
    ];
    document.getElementById('overview-cards').innerHTML=cards.map(c=>`<div class="card"><div class="label">${c.label}</div><div class="value">${c.value}</div><div class="sub">${c.sub}</div></div>`).join('');

    loadScheduler(sched);
  }catch(e){console.error(e);}
}

function loadScheduler(data){
  const render=d=>{
    const s=d?.scheduler||d||{};
    const adapters=s.adapters||s.accounts||[];
    if(!Array.isArray(adapters)){document.getElementById('adapter-tbody').innerHTML='<tr><td colspan="5" style="color:var(--text2)">No adapter data available</td></tr>';return;}
    document.getElementById('adapter-tbody').innerHTML=adapters.map(a=>`<tr>
      <td><span class="dot ${a.cooldown_until?'dot-orange':(a.healthy!==false?'dot-green':'dot-red')}"></span>${a.name||a.id||'‚Äî'}</td>
      <td>${a.cooldown_until?'Cooldown':(a.healthy!==false?'Active':'Failed')}</td>
      <td style="font-family:monospace;font-size:12px">${a.model||'‚Äî'}</td>
      <td>${a.request_count||0}</td>
      <td>${a.failure_count||0}</td>
    </tr>`).join('');
  };
  if(data){render(data);return;}
  api('/admin/scheduler').then(render).catch(()=>{});
}

// SETTINGS
async function loadSettings(){
  try{
    const s=await api('/admin/settings');
    document.getElementById('set-reflection').value=s.routing?.reflection_passes||1;
    document.getElementById('set-timeout').value=s.routing?.timeout_ms||30000;
    document.getElementById('set-candidates').value=s.routing?.parallel_candidates||1;
    document.getElementById('set-retries').value=s.routing?.retries||1;
    document.getElementById('set-toolmode').value=s.tool_loop?.mode||'client_loop';
    document.getElementById('set-maxsteps').value=s.tool_loop?.max_steps||4;
    document.getElementById('set-judge').checked=!!s.routing?.enable_response_judge;
    document.getElementById('set-experimental').checked=!!s.allow_experimental_tools;
    document.getElementById('set-mode-models').value=JSON.stringify(s.mode_models||{},null,2);
    document.getElementById('set-model-mappings').value=JSON.stringify(s.model_mappings||{},null,2);
    document.getElementById('set-model-map-strict').checked=!!s.model_map_strict;
    document.getElementById('set-model-map-fallback').value=s.model_map_fallback||'';
    document.getElementById('set-prompts').value=JSON.stringify(s.prompt_prefixes||{},null,2);
    document.getElementById('set-routes').value=JSON.stringify(s.routing?.mode_routes||{},null,2);
  }catch(e){}
}

async function saveSettings(){
  try{
    const body={
      use_mode_model_override:Object.keys(JSON.parse(document.getElementById('set-mode-models').value||'{}')).length>0,
      mode_models:JSON.parse(document.getElementById('set-mode-models').value||'{}'),
      model_mappings:JSON.parse(document.getElementById('set-model-mappings').value||'{}'),
      model_map_strict:document.getElementById('set-model-map-strict').checked,
      model_map_fallback:(document.getElementById('set-model-map-fallback').value||'').trim(),
      prompt_prefixes:JSON.parse(document.getElementById('set-prompts').value||'{}'),
      allow_experimental_tools:document.getElementById('set-experimental').checked,
      allow_unknown_tools:true,
      routing:{
        retries:+document.getElementById('set-retries').value,
        reflection_passes:+document.getElementById('set-reflection').value,
        timeout_ms:+document.getElementById('set-timeout').value,
        parallel_candidates:+document.getElementById('set-candidates').value,
        enable_response_judge:document.getElementById('set-judge').checked,
        mode_routes:JSON.parse(document.getElementById('set-routes').value||'{}')
      },
      tool_loop:{mode:document.getElementById('set-toolmode').value,max_steps:+document.getElementById('set-maxsteps').value}
    };
    await api('/admin/settings',{method:'PUT',body:JSON.stringify(body)});
    toast('Settings saved');
  }catch(e){ toast('Failed to save: '+e.message,false); }
}

// MODELS
async function loadModels(){
  try{
    const s=await api('/admin/settings');
    const modes=s.mode_models||{};
    const runtimeMap=s.model_mappings||{};
    const modeCards=Object.entries(modes).map(([m,v])=>`<div class="card"><div class="label">Mode ${m}</div><div class="value" style="font-size:16px;font-family:monospace">${v}</div></div>`);
    const mapCards=Object.entries(runtimeMap).map(([m,v])=>`<div class="card"><div class="label">Map ${m}</div><div class="value" style="font-size:16px;font-family:monospace">${v}</div></div>`);
    const cards=[...modeCards,...mapCards];
    document.getElementById('model-cards').innerHTML=cards.length?cards.join(''):'<div class="card"><div class="label">Default</div><div class="value" style="font-size:14px;color:var(--text2)">No model settings configured</div></div>';
    const routes=s.routing?.mode_routes||{};
    const re=Object.entries(routes);
    document.getElementById('route-tbody').innerHTML=re.length?re.map(([m,chain])=>`<tr><td>${m}</td><td style="font-family:monospace;font-size:12px">${chain.join(' ‚Üí ')}</td></tr>`).join(''):'<tr><td colspan="2" style="color:var(--text2)">No routes configured</td></tr>';
    loadUpstreamAdmin();
  }catch(e){}
}

async function loadUpstreamAdmin(){
  try{
    const cfg=await api('/admin/upstream');
    document.getElementById('upstream-admin-json').value=JSON.stringify(cfg||{},null,2);
  }catch(e){}
}

async function saveUpstreamAdmin(){
  try{
    const body=JSON.parse(document.getElementById('upstream-admin-json').value||'{}');
    const updated=await api('/admin/upstream',{method:'PUT',body:JSON.stringify(body)});
    document.getElementById('upstream-admin-json').value=JSON.stringify(updated||{},null,2);
    toast('Upstream config applied');
  }catch(e){
    toast('Failed to apply upstream config: '+e.message,false);
  }
}

// TOOLS
async function loadTools(){
  try{
    const d=await api('/admin/tools');
    const tools=d.tools||[];
    document.getElementById('tools-tbody').innerHTML=tools.length?tools.map(t=>`<tr>
      <td style="font-family:monospace">${t.name}</td>
      <td><span class="badge ${t.category==='supported'?'badge-green':t.category==='experimental'?'badge-orange':'badge-red'}">${t.category||'unknown'}</span></td>
      <td>${t.enabled!==false?'Enabled':'Disabled'}</td>
    </tr>`).join(''):'<tr><td colspan="3" style="color:var(--text2)">No tools configured</td></tr>';
  }catch(e){}
}

function enc(v){ return encodeURIComponent(v||''); }
function dec(v){ return decodeURIComponent(v||''); }

function parseJSONArrayInput(text,label){
  const raw=(text||'').trim();
  if(!raw) return [];
  const parsed=JSON.parse(raw);
  if(!Array.isArray(parsed)) throw new Error((label||'value')+' must be a JSON array');
  return parsed;
}

// PLUGINS
async function loadPlugins(){
  try{
    const d=await api('/v1/cc/plugins?limit=200');
    const items=d.data||[];
    document.getElementById('plugin-tbody').innerHTML=items.length?items.map(p=>`<tr>
      <td style="font-family:monospace">${p.name}</td>
      <td style="font-family:monospace">${p.version||'‚Äî'}</td>
      <td>${p.enabled?'<span class="badge badge-green">Enabled</span>':'<span class="badge badge-red">Disabled</span>'}</td>
      <td>${(p.skills||[]).length}</td>
      <td>${(p.hooks||[]).length}</td>
      <td>${(p.mcp_servers||[]).length}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-outline btn-sm" onclick="viewPluginByKey('${enc(p.name)}')">View</button>
        <button class="btn btn-outline btn-sm" onclick="enablePluginByKey('${enc(p.name)}')">Enable</button>
        <button class="btn btn-outline btn-sm" onclick="disablePluginByKey('${enc(p.name)}')">Disable</button>
        <button class="btn btn-danger btn-sm" onclick="deletePluginByKey('${enc(p.name)}')">Delete</button>
      </td>
    </tr>`).join(''):'<tr><td colspan="7" style="color:var(--text2)">No plugins installed</td></tr>';
  }catch(e){}
}

async function installPlugin(){
  try{
    const body={
      name:(document.getElementById('plugin-name').value||'').trim(),
      version:(document.getElementById('plugin-version').value||'').trim(),
      description:(document.getElementById('plugin-desc').value||'').trim(),
      skills:parseJSONArrayInput(document.getElementById('plugin-skills').value,'skills'),
      hooks:parseJSONArrayInput(document.getElementById('plugin-hooks').value,'hooks'),
      mcp_servers:parseJSONArrayInput(document.getElementById('plugin-mcp').value,'mcp_servers'),
    };
    if(!body.name){ toast('plugin name is required',false); return; }
    const d=await api('/v1/cc/plugins',{method:'POST',body:JSON.stringify(body)});
    document.getElementById('plugin-preview').value=JSON.stringify(d,null,2);
    toast('Plugin installed');
    loadPlugins();
  }catch(e){ toast('Install plugin failed: '+e.message,false); }
}

async function viewPluginByKey(key){
  const name=dec(key);
  try{
    const d=await api('/v1/cc/plugins/'+enc(name));
    document.getElementById('plugin-preview').value=JSON.stringify(d,null,2);
  }catch(e){}
}

async function enablePluginByKey(key){
  const name=dec(key);
  try{
    const d=await api('/v1/cc/plugins/'+enc(name)+'/enable',{method:'POST',body:'{}'});
    document.getElementById('plugin-preview').value=JSON.stringify(d,null,2);
    toast('Plugin enabled');
    loadPlugins();
  }catch(e){}
}

async function disablePluginByKey(key){
  const name=dec(key);
  try{
    const d=await api('/v1/cc/plugins/'+enc(name)+'/disable',{method:'POST',body:'{}'});
    document.getElementById('plugin-preview').value=JSON.stringify(d,null,2);
    toast('Plugin disabled');
    loadPlugins();
  }catch(e){}
}

async function deletePluginByKey(key){
  const name=dec(key);
  if(!confirm('Delete plugin '+name+' ?')) return;
  try{
    await api('/v1/cc/plugins/'+enc(name),{method:'DELETE'});
    document.getElementById('plugin-preview').value='';
    toast('Plugin deleted');
    loadPlugins();
  }catch(e){}
}

function parseJSONArray(text){
  const raw=(text||'').trim();
  if(!raw) return [];
  const arr=JSON.parse(raw);
  if(!Array.isArray(arr)) throw new Error('args must be a JSON array');
  return arr;
}

// MCP
async function loadMCPServers(){
  try{
    const d=await api('/v1/cc/mcp/servers?limit=200');
    const items=d.data||[];
    document.getElementById('mcp-tbody').innerHTML=items.length?items.map(s=>`<tr>
      <td style="font-family:monospace">${s.id}</td>
      <td>${s.name||'‚Äî'}</td>
      <td>${s.transport||'‚Äî'}</td>
      <td style="font-family:monospace;font-size:12px">${s.url||s.command||'‚Äî'}</td>
      <td>${s.status?.healthy===false?'<span class="badge badge-red">Down</span>':'<span class="badge badge-green">Up</span>'}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-outline btn-sm" onclick="mcpHealth('${s.id}')">Health</button>
        <button class="btn btn-outline btn-sm" onclick="mcpReconnect('${s.id}')">Reconnect</button>
        <button class="btn btn-outline btn-sm" onclick="mcpListTools('${s.id}')">Tools</button>
        <button class="btn btn-danger btn-sm" onclick="mcpDelete('${s.id}')">Delete</button>
      </td>
    </tr>`).join(''):'<tr><td colspan="6" style="color:var(--text2)">No MCP servers</td></tr>';
  }catch(e){}
}

async function registerMCPServer(){
  try{
    const transport=document.getElementById('mcp-transport').value;
    const body={
      id:(document.getElementById('mcp-id').value||'').trim()||undefined,
      name:(document.getElementById('mcp-name').value||'').trim(),
      transport,
      timeout_ms:+(document.getElementById('mcp-timeout').value||15000),
      retries:+(document.getElementById('mcp-retries').value||1),
    };
    if(transport==='http'){
      body.url=(document.getElementById('mcp-url').value||'').trim();
    }else{
      body.command=(document.getElementById('mcp-command').value||'').trim();
      body.args=parseJSONArray(document.getElementById('mcp-args').value);
    }
    await api('/v1/cc/mcp/servers',{method:'POST',body:JSON.stringify(body)});
    toast('MCP server registered');
    loadMCPServers();
  }catch(e){ toast('Register MCP failed: '+e.message,false); }
}

async function mcpHealth(id){
  try{ await api('/v1/cc/mcp/servers/'+encodeURIComponent(id)+'/health',{method:'POST',body:'{}'}); toast('Health check done'); loadMCPServers(); }catch(e){}
}
async function mcpReconnect(id){
  try{ await api('/v1/cc/mcp/servers/'+encodeURIComponent(id)+'/reconnect',{method:'POST',body:'{}'}); toast('Reconnect done'); loadMCPServers(); }catch(e){}
}
async function mcpDelete(id){
  if(!confirm('Delete MCP server '+id+' ?')) return;
  try{ await api('/v1/cc/mcp/servers/'+encodeURIComponent(id),{method:'DELETE'}); toast('MCP server deleted'); loadMCPServers(); document.getElementById('mcp-tools-preview').value=''; }catch(e){}
}
async function mcpListTools(id){
  try{
    const d=await api('/v1/cc/mcp/servers/'+encodeURIComponent(id)+'/tools/list',{method:'POST',body:'{}'});
    document.getElementById('mcp-tools-preview').value=JSON.stringify(d,null,2);
  }catch(e){}
}

// Teams
async function loadTeams(){
  try{
    const d=await api('/v1/cc/teams?limit=200');
    const items=d.data||[];
    document.getElementById('team-tbody').innerHTML=items.length?items.map(t=>`<tr>
      <td style="font-family:monospace">${t.id}</td>
      <td>${t.name||'‚Äî'}</td>
      <td>${t.agent_count||0}</td>
      <td>${t.task_count||0}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-outline btn-sm" onclick="selectTeam('${t.id}')">Select</button>
        <button class="btn btn-outline btn-sm" onclick="loadTeamTasks('${t.id}')">Tasks</button>
        <button class="btn btn-primary btn-sm" onclick="orchestrateTeam('${t.id}')">Run</button>
      </td>
    </tr>`).join(''):'<tr><td colspan="5" style="color:var(--text2)">No teams</td></tr>';
  }catch(e){}
}

function selectTeam(id){
  document.getElementById('team-task-team').value=id||'';
}

async function createTeam(){
  try{
    const id=(document.getElementById('team-create-id').value||'').trim();
    const name=(document.getElementById('team-create-name').value||'').trim();
    const leadID=(document.getElementById('team-create-lead').value||'').trim()||'lead';
    const leadModel=(document.getElementById('team-create-model').value||'').trim()||'default';
    const body={id:id||undefined,name,agents:[{id:leadID,name:leadID,role:'lead',model:leadModel}]};
    await api('/v1/cc/teams',{method:'POST',body:JSON.stringify(body)});
    toast('Team created');
    document.getElementById('team-task-team').value=id||'';
    loadTeams();
  }catch(e){ toast('Create team failed: '+e.message,false); }
}

async function createTeamTask(){
  const teamID=(document.getElementById('team-task-team').value||'').trim();
  if(!teamID){ toast('team id is required',false); return; }
  try{
    const body={
      title:(document.getElementById('team-task-title').value||'').trim(),
      assigned_to:(document.getElementById('team-task-assigned').value||'').trim(),
    };
    const d=await api('/v1/cc/teams/'+encodeURIComponent(teamID)+'/tasks',{method:'POST',body:JSON.stringify(body)});
    document.getElementById('team-task-result').value=JSON.stringify(d,null,2);
    toast('Team task created');
    loadTeams();
  }catch(e){}
}

async function orchestrateTeam(teamID){
  teamID=(teamID||document.getElementById('team-task-team').value||'').trim();
  if(!teamID){ toast('team id is required',false); return; }
  try{
    const d=await api('/v1/cc/teams/'+encodeURIComponent(teamID)+'/orchestrate',{method:'POST'});
    document.getElementById('team-task-result').value=JSON.stringify(d,null,2);
    toast('Team orchestrated');
    loadTeams();
  }catch(e){}
}

async function loadTeamTasks(teamID){
  teamID=(teamID||document.getElementById('team-task-team').value||'').trim();
  if(!teamID){ toast('team id is required',false); return; }
  try{
    const d=await api('/v1/cc/teams/'+encodeURIComponent(teamID)+'/tasks');
    document.getElementById('team-task-result').value=JSON.stringify(d,null,2);
  }catch(e){}
}

// Subagents
function buildSubagentQuery(){
  const q=new URLSearchParams();
  const parent=(document.getElementById('sub-filter-parent').value||'').trim();
  const status=(document.getElementById('sub-filter-status').value||'').trim();
  const model=(document.getElementById('sub-filter-model').value||'').trim();
  const includeDeleted=(document.getElementById('sub-filter-deleted').value||'false').trim();
  if(parent) q.set('team_id',parent);
  if(status) q.set('status',status);
  if(model) q.set('model',model);
  if(includeDeleted==='true') q.set('include_deleted','true');
  return q.toString();
}

async function loadSubagents(){
  try{
    const q=buildSubagentQuery();
    const d=await api('/v1/cc/subagents'+(q?('?'+q):''));
    const items=d.data||[];
    document.getElementById('subagent-tbody').innerHTML=items.length?items.map(s=>`<tr>
      <td style="font-family:monospace">${s.id}</td>
      <td style="font-family:monospace">${s.parent_id||'‚Äî'}</td>
      <td>${s.status||'‚Äî'}</td>
      <td style="font-family:monospace">${s.model||'‚Äî'}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-outline btn-sm" onclick="loadSubagentTimeline('${s.id}')">Timeline</button>
        <button class="btn btn-outline btn-sm" onclick="terminateSubagent('${s.id}')">Terminate</button>
        <button class="btn btn-danger btn-sm" onclick="deleteSubagent('${s.id}')">Delete</button>
      </td>
    </tr>`).join(''):'<tr><td colspan="5" style="color:var(--text2)">No subagents</td></tr>';
  }catch(e){}
}

async function terminateSubagent(id){
  const by=prompt('terminated by (optional)','admin')||'';
  const reason=prompt('termination reason (optional)','manual stop')||'';
  try{ await api('/v1/cc/subagents/'+encodeURIComponent(id)+'/terminate',{method:'POST',body:JSON.stringify({by,reason})}); toast('Subagent terminated'); loadSubagents(); loadSubagentTimeline(id); }catch(e){}
}
async function deleteSubagent(id){
  if(!confirm('Delete subagent '+id+' ?')) return;
  const by=prompt('deleted by (optional)','admin')||'';
  const reason=prompt('delete reason (optional)','cleanup')||'';
  try{ await api('/v1/cc/subagents/'+encodeURIComponent(id),{method:'DELETE',body:JSON.stringify({by,reason})}); toast('Subagent deleted'); loadSubagents(); loadSubagentTimeline(id); }catch(e){}
}
async function loadSubagentTimeline(id){
  try{
    const d=await api('/v1/cc/subagents/'+encodeURIComponent(id)+'/timeline?limit=200');
    document.getElementById('subagent-timeline').value=JSON.stringify(d,null,2);
  }catch(e){}
}

// Events
let eventStreamSource=null;

function buildEventQuery(){
  const q=new URLSearchParams();
  const fields=[
    ['event_type','evt-type'],
    ['session_id','evt-session'],
    ['run_id','evt-run'],
    ['plan_id','evt-plan'],
    ['todo_id','evt-todo'],
    ['team_id','evt-team'],
    ['subagent_id','evt-subagent'],
  ];
  fields.forEach(([k,id])=>{
    const v=(document.getElementById(id).value||'').trim();
    if(v) q.set(k,v);
  });
  const limit=(document.getElementById('evt-limit').value||'').trim();
  if(limit) q.set('limit',limit);
  return q;
}

function renderEvents(items,prepend=false){
  const tbody=document.getElementById('event-tbody');
  const rows=(items||[]).map(ev=>`<tr>
    <td style="font-family:monospace;font-size:12px">${ev.created_at||'‚Äî'}</td>
    <td>${ev.event_type||'‚Äî'}</td>
    <td style="font-family:monospace">${ev.team_id||ev.data?.team_id||'‚Äî'}</td>
    <td style="font-family:monospace">${ev.subagent_id||ev.data?.subagent_id||'‚Äî'}</td>
    <td style="font-size:12px;color:var(--text2)">${ev.data?.record_text||'‚Äî'}</td>
  </tr>`).join('');
  if(prepend) tbody.innerHTML=rows+tbody.innerHTML;
  else tbody.innerHTML=rows||'<tr><td colspan="5" style="color:var(--text2)">No events</td></tr>';
}

async function loadEvents(){
  try{
    const q=buildEventQuery();
    const d=await api('/v1/cc/events'+(q.toString()?('?'+q.toString()):''));
    renderEvents(d.data||[]);
  }catch(e){}
}

function startEventStream(){
  stopEventStream();
  const q=buildEventQuery();
  const eventType=(q.get('event_type')||'').trim();
  q.delete('limit');
  const url=BASE+'/v1/cc/events/stream?'+q.toString();
  const es=new EventSource(url);
  eventStreamSource=es;
  const onData=(msg)=>{
    try{
      const ev=JSON.parse(msg.data||'{}');
      renderEvents([ev],true);
    }catch(e){}
  };
  const knownTypes=[
    'run.created','run.completed','run.failed',
    'todo.created','todo.updated','todo.completed',
    'plan.created','plan.approved','plan.executing','plan.completed','plan.failed','plan.todos_created','plan.todos_synced','plan.step_advanced','plan.auto_completed',
    'team.created','team.agent.added','team.task.created','team.task.running','team.task.completed','team.task.failed','team.message.sent','team.orchestrated',
    'subagent.created','subagent.running','subagent.completed','subagent.failed','subagent.terminated','subagent.deleted',
    'plugin.installed','plugin.enabled','plugin.disabled','plugin.uninstalled',
  ];
  if(eventType){
    es.addEventListener(eventType,onData);
  }else{
    knownTypes.forEach(type=>es.addEventListener(type,onData));
    es.onmessage=onData;
  }
  es.onerror=()=>toast('Event stream disconnected',false);
  toast('Event stream started');
}

function stopEventStream(){
  if(eventStreamSource){
    eventStreamSource.close();
    eventStreamSource=null;
    toast('Event stream stopped');
  }
}

// TODOS
function buildTodoQuery(){
  const q=new URLSearchParams();
  const fields=[
    ['status','todo-filter-status'],
    ['plan_id','todo-filter-plan'],
    ['session_id','todo-filter-session'],
  ];
  fields.forEach(([k,id])=>{
    const v=(document.getElementById(id).value||'').trim();
    if(v) q.set(k,v);
  });
  const limit=(document.getElementById('todo-filter-limit').value||'').trim();
  if(limit) q.set('limit',limit);
  return q.toString();
}

async function loadTodos(){
  try{
    const q=buildTodoQuery();
    const d=await api('/v1/cc/todos'+(q?('?'+q):''));
    const items=d.data||[];
    document.getElementById('todo-tbody').innerHTML=items.length?items.map(td=>`<tr>
      <td style="font-family:monospace">${td.id}</td>
      <td>${td.title||'‚Äî'}</td>
      <td>${td.status||'‚Äî'}</td>
      <td style="font-family:monospace">${td.plan_id||'‚Äî'}</td>
      <td style="font-family:monospace">${td.session_id||'‚Äî'}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-outline btn-sm" onclick="viewTodoByKey('${enc(td.id)}')">View</button>
        <button class="btn btn-outline btn-sm" onclick="updateTodoStatusByKey('${enc(td.id)}','in_progress')">Start</button>
        <button class="btn btn-outline btn-sm" onclick="updateTodoStatusByKey('${enc(td.id)}','completed')">Done</button>
        <button class="btn btn-outline btn-sm" onclick="updateTodoStatusByKey('${enc(td.id)}','blocked')">Block</button>
      </td>
    </tr>`).join(''):'<tr><td colspan="6" style="color:var(--text2)">No todos</td></tr>';
  }catch(e){}
}

async function createTodo(){
  try{
    const body={
      id:(document.getElementById('todo-id').value||'').trim()||undefined,
      title:(document.getElementById('todo-title').value||'').trim(),
      description:(document.getElementById('todo-desc').value||'').trim(),
      status:(document.getElementById('todo-status').value||'pending').trim(),
      plan_id:(document.getElementById('todo-plan-id').value||'').trim(),
      session_id:(document.getElementById('todo-session-id').value||'').trim(),
      run_id:(document.getElementById('todo-run-id').value||'').trim(),
    };
    if(!body.title){ toast('todo title is required',false); return; }
    const d=await api('/v1/cc/todos',{method:'POST',body:JSON.stringify(body)});
    document.getElementById('todo-preview').value=JSON.stringify(d,null,2);
    toast('Todo created');
    loadTodos();
  }catch(e){ toast('Create todo failed: '+e.message,false); }
}

async function updateTodoStatusByKey(key,status){
  const id=dec(key);
  try{
    const d=await api('/v1/cc/todos/'+enc(id),{method:'PUT',body:JSON.stringify({status})});
    document.getElementById('todo-preview').value=JSON.stringify(d,null,2);
    toast('Todo updated');
    loadTodos();
  }catch(e){}
}

async function viewTodoByKey(key){
  const id=dec(key);
  try{
    const d=await api('/v1/cc/todos/'+enc(id));
    document.getElementById('todo-preview').value=JSON.stringify(d,null,2);
  }catch(e){}
}

// PLANS
function parsePlanSteps(text){
  return (text||'').split('\n').map(line=>line.trim()).filter(Boolean).map(line=>{
    const idx=line.indexOf('|');
    if(idx<0) return {title:line};
    return {
      title:line.slice(0,idx).trim(),
      description:line.slice(idx+1).trim(),
    };
  }).filter(step=>step.title);
}

function buildPlanQuery(){
  const q=new URLSearchParams();
  const fields=[
    ['status','plan-filter-status'],
    ['session_id','plan-filter-session'],
    ['run_id','plan-filter-run'],
  ];
  fields.forEach(([k,id])=>{
    const v=(document.getElementById(id).value||'').trim();
    if(v) q.set(k,v);
  });
  const limit=(document.getElementById('plan-filter-limit').value||'').trim();
  if(limit) q.set('limit',limit);
  return q.toString();
}

async function loadPlans(){
  try{
    const q=buildPlanQuery();
    const d=await api('/v1/cc/plans'+(q?('?'+q):''));
    const items=d.data||[];
    document.getElementById('plan-tbody').innerHTML=items.length?items.map(p=>`<tr>
      <td style="font-family:monospace">${p.id}</td>
      <td>${p.title||'‚Äî'}</td>
      <td>${p.status||'‚Äî'}</td>
      <td>${(p.steps||[]).length}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-outline btn-sm" onclick="viewPlanByKey('${enc(p.id)}')">View</button>
        <button class="btn btn-outline btn-sm" onclick="approvePlanByKey('${enc(p.id)}')">Approve</button>
        <button class="btn btn-outline btn-sm" onclick="executePlanByKey('${enc(p.id)}','step')">Step</button>
        <button class="btn btn-outline btn-sm" onclick="executePlanByKey('${enc(p.id)}','complete')">Complete</button>
        <button class="btn btn-outline btn-sm" onclick="executePlanByKey('${enc(p.id)}','failed')">Fail</button>
      </td>
    </tr>`).join(''):'<tr><td colspan="5" style="color:var(--text2)">No plans</td></tr>';
  }catch(e){}
}

async function createPlan(){
  try{
    const body={
      id:(document.getElementById('plan-id').value||'').trim()||undefined,
      title:(document.getElementById('plan-title').value||'').trim(),
      summary:(document.getElementById('plan-summary').value||'').trim(),
      session_id:(document.getElementById('plan-session-id').value||'').trim(),
      run_id:(document.getElementById('plan-run-id').value||'').trim(),
      steps:parsePlanSteps(document.getElementById('plan-steps').value),
    };
    if(!body.title){ toast('plan title is required',false); return; }
    const d=await api('/v1/cc/plans',{method:'POST',body:JSON.stringify(body)});
    document.getElementById('plan-preview').value=JSON.stringify(d,null,2);
    toast('Plan created');
    loadPlans();
    if(d.id) document.getElementById('todo-plan-id').value=d.id;
  }catch(e){ toast('Create plan failed: '+e.message,false); }
}

async function approvePlanByKey(key){
  const id=dec(key);
  try{
    const d=await api('/v1/cc/plans/'+enc(id)+'/approve',{method:'POST',body:'{}'});
    document.getElementById('plan-preview').value=JSON.stringify(d,null,2);
    toast('Plan approved');
    loadPlans();
  }catch(e){}
}

async function executePlanByKey(key,mode){
  const id=dec(key);
  const body={};
  if(mode==='complete') body.complete=true;
  if(mode==='failed') body.failed=true;
  try{
    const d=await api('/v1/cc/plans/'+enc(id)+'/execute',{method:'POST',body:JSON.stringify(body)});
    document.getElementById('plan-preview').value=JSON.stringify(d,null,2);
    toast('Plan execution updated');
    loadPlans();
    loadTodos();
  }catch(e){}
}

async function viewPlanByKey(key){
  const id=dec(key);
  try{
    const [planResp,todoResp]=await Promise.all([
      api('/v1/cc/plans/'+enc(id)),
      api('/v1/cc/todos?plan_id='+enc(id)+'&limit=200').catch(()=>({data:[]}))
    ]);
    const merged={plan:planResp,linked_todos:todoResp.data||[]};
    document.getElementById('plan-preview').value=JSON.stringify(merged,null,2);
  }catch(e){}
}

// SKILLS ‚Äî local state since no /admin/skills yet
let localSkills=[];
async function loadSkills(){
  try{
    const d=await api('/v1/cc/skills');
    localSkills=d.data||[];
    renderSkills();
  }catch(e){ renderSkills(); }
}
function renderSkills(){
  document.getElementById('skills-tbody').innerHTML=localSkills.length?localSkills.map(s=>`<tr>
    <td style="font-family:monospace">${s.name}</td>
    <td>${s.description||'‚Äî'}</td>
    <td style="font-family:monospace;font-size:12px">${Object.keys(s.parameters||{}).join(', ')||'none'}</td>
    <td><button class="btn btn-danger btn-sm" onclick="deleteSkill('${s.name}')">Delete</button></td>
  </tr>`).join(''):'<tr><td colspan="4" style="color:var(--text2)">No skills registered</td></tr>';
}
function showSkillForm(){document.getElementById('skill-form-panel').style.display='block';}
function hideSkillForm(){document.getElementById('skill-form-panel').style.display='none';}

async function registerSkill(){
  try{
    const body={name:document.getElementById('skill-name').value,description:document.getElementById('skill-desc').value,template:document.getElementById('skill-template').value,parameters:JSON.parse(document.getElementById('skill-params').value||'{}')};
    await api('/v1/cc/skills',{method:'POST',body:JSON.stringify(body)});
    toast('Skill registered');
    hideSkillForm();
    loadSkills();
  }catch(e){}
}
async function deleteSkill(name){
  try{await fetch(BASE+'/v1/cc/skills/'+name,{method:'DELETE',headers:headers()});toast('Skill deleted');loadSkills();}catch(e){}
}

// RULES ‚Äî local state
let localRules=[];
function loadRules(){renderRules();}
function renderRules(){
  document.getElementById('rules-tbody').innerHTML=localRules.length?localRules.map((r,i)=>`<tr>
    <td style="font-family:monospace">${r.name}</td>
    <td style="font-family:monospace">${r.pattern}</td>
    <td><span class="badge ${r.action==='allow'?'badge-green':r.action==='deny'?'badge-red':'badge-orange'}">${r.action}</span></td>
    <td>${r.priority}</td>
    <td>${r.scope||'global'}</td>
    <td><button class="btn btn-danger btn-sm" onclick="removeRule(${i})">Remove</button></td>
  </tr>`).join(''):'<tr><td colspan="6" style="color:var(--text2)">No rules configured</td></tr>';
}
function showRuleForm(){document.getElementById('rule-form-panel').style.display='block';}
function hideRuleForm(){document.getElementById('rule-form-panel').style.display='none';}
function addRule(){
  localRules.push({name:document.getElementById('rule-name').value,pattern:document.getElementById('rule-pattern').value,action:document.getElementById('rule-action').value,priority:+document.getElementById('rule-priority').value,scope:document.getElementById('rule-scope').value||'global'});
  localRules.sort((a,b)=>b.priority-a.priority);
  toast('Rule added');hideRuleForm();renderRules();
}
function removeRule(i){localRules.splice(i,1);renderRules();}

// COST
async function loadCost(){
  try{
    const d=await api('/admin/cost');
    const total=d.total_cost_usd||0;
    const budget=d.budget_limit_usd||0;
    const models=d.per_model||{};
    document.getElementById('cost-cards').innerHTML=`
      <div class="card"><div class="label">Total Cost</div><div class="value">$${total.toFixed(4)}</div></div>
      <div class="card"><div class="label">Budget Limit</div><div class="value">${budget>0?'$'+budget.toFixed(2):'No Limit'}</div><div class="sub">${budget>0?((total/budget*100).toFixed(1)+'% used'):'unlimited'}</div></div>
      <div class="card"><div class="label">Models Tracked</div><div class="value">${Object.keys(models).length}</div></div>
    `;
    const rows=Object.entries(models);
    document.getElementById('cost-tbody').innerHTML=rows.length?rows.map(([m,v])=>`<tr>
      <td style="font-family:monospace">${m}</td><td>${v.requests||0}</td><td>${v.input_tokens||0}</td><td>${v.output_tokens||0}</td><td>$${(v.cost||0).toFixed(4)}</td>
    </tr>`).join(''):'<tr><td colspan="5" style="color:var(--text2)">No cost data yet</td></tr>';
  }catch(e){
    document.getElementById('cost-cards').innerHTML='<div class="card"><div class="label">Status</div><div class="value" style="font-size:14px;color:var(--text2)">Cost tracking endpoint not configured</div></div>';
    document.getElementById('cost-tbody').innerHTML='';
  }
}

// EVAL
async function runEval(){
  const model=document.getElementById('eval-model').value;
  const prompt=document.getElementById('eval-prompt').value;
  const response=document.getElementById('eval-response').value;
  if(!prompt){toast('Please enter a prompt',false);return;}
  try{
    const d=await api('/v1/cc/eval',{method:'POST',body:JSON.stringify({model,prompt,response:response||undefined})});
    const r=d.result||d;
    document.getElementById('eval-results').style.display='block';
    const criteria=r.criteria||{};
    document.getElementById('eval-cards').innerHTML=`
      <div class="card"><div class="label">Overall Score</div><div class="value" style="color:${r.score>=7?'var(--green)':r.score>=4?'var(--orange)':'var(--red)'}">${(r.score||0).toFixed(1)}/10</div></div>
      ${Object.entries(criteria).map(([k,v])=>`<div class="card"><div class="label">${k.replace(/_/g,' ')}</div><div class="value" style="font-size:22px;color:${v>=7?'var(--green)':v>=4?'var(--orange)':'var(--red)'}">${v.toFixed(1)}</div></div>`).join('')}
    `;
    document.getElementById('eval-analysis').textContent=r.analysis||'No analysis available';
    toast('Evaluation complete');
  }catch(e){ toast('Eval failed: '+e.message,false); }
}

// Init
loadOverview();
</script>
</body>
</html>
