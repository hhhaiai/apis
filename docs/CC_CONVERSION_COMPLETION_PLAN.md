# Claude Code 转换系统完善计划

> 第二部分收尾路线图（面向最终可移植目标）  
> 更新时间：2026-02-16

## 1. 目标定义

本阶段不再做“功能堆叠”，只做上线收口。最终目标：

1. 协议稳定：Claude/OpenAI/CC 接口行为在灰度期保持兼容。
2. 运维可控：后台可追踪、可回溯、可定位失败原因。
3. 迁移可落地：状态可持久化、配置可备份、故障可回滚。

## 2. 当前基线（已具备）

1. 协议转换、模型映射、工具回路、MCP、插件市场已上线可用。
2. 用户/令牌/配额、渠道管理已接入请求主链路（默认内存实现）。
3. 请求解码诊断已闭环：
   - 事件：`request.unsupported_fields`、`request.decode_failed`
   - runlog：`reason/unsupported_fields/request_body/curl_command`
   - 后台 Events 可视化查看请求体与复现 curl。

## 3. 收尾计划（分阶段）

### 阶段 A：状态持久化与恢复（P0）

目标：消除重启丢状态风险。

任务：

1. 为 Auth/Token/Channel 引入持久化后端（文件或数据库）。
2. 增加启动恢复与版本迁移机制（含 schema 版本号）。
3. 补充备份/恢复脚本与演练文档。

验收标准：

1. 重启后用户、令牌、渠道配置完全恢复。
2. 持久化读写失败时有可观测错误事件，不 silent fail。
3. 关键恢复路径有自动化测试。

### 阶段 B：安全与治理收敛（P0）

目标：满足生产最小安全要求。

任务：

1. 移除对默认管理员口令的依赖（启动强提醒 + 部署检查项）。
2. 固化 token 策略模板（模型白名单、IP 限制、额度上限）。
3. 完成日志脱敏策略文档（请求复现、token 字段、审计留痕）。

验收标准：

1. 生产部署脚本默认拒绝弱口令配置。
2. 管理端核心操作都有鉴权与审计记录。
3. 敏感字段不会通过事件与 runlog 泄露。

### 阶段 C：迁移回归与灰度（P0）

目标：确保迁移过程可控、可回滚。

任务：

1. 建立“关键请求样本集”（Anthropic/OpenAI/CC 各至少一组）。
2. 回归未知字段、trailing JSON、空 body 等边界场景。
3. 建立灰度监控面板（错误率、延迟、诊断事件数量）。
4. 制定回滚触发条件和操作手册。

验收标准：

1. 样本集回归全通过。
2. 灰度期间关键指标可观测且阈值可告警。
3. 回滚演练可在约定时间内完成。

### 阶段 D：上下文能力补完（P1）

目标：提升长会话质量，不阻塞主迁移。

任务：

1. 补齐 `SummarizeSession` 与 `ExtractKeyInfo` 的生产实现。
2. 定义长期记忆存储策略（是否引入向量库）。
3. 明确记忆写入开关和成本控制策略。

验收标准：

1. 长会话场景质量回归有量化对比。
2. 记忆能力可开关、可降级、可观测。

## 4. 里程碑与交付物

1. M1（阶段 A 完成）
   - 持久化方案文档
   - 恢复测试与备份脚本
2. M2（阶段 B 完成）
   - 安全基线清单
   - 管理端鉴权审计说明
3. M3（阶段 C 完成）
   - 灰度报告
   - 回滚演练记录
4. M4（阶段 D 完成，可选）
   - 记忆系统性能与质量报告

## 5. 成功判定（最终）

满足以下条件即可判定“转换阶段收尾完成”：

1. 协议兼容回归通过。
2. 关键状态可持久化恢复。
3. 诊断与审计可支持线上排障。
4. 灰度与回滚流程完成演练并文档化。
