# 必须要做的功能分析（更新版）

> 基于当前代码实际状态的差距分析  
> 更新时间：2026-02-16

## 1. 执行摘要

与旧版评估不同，以下能力已经落地：

1. 用户管理（`internal/auth`）已接入后台与主程序。
2. 令牌管理（`internal/token`）已接入网关鉴权、模型/IP 限制与额度扣减。
3. 渠道管理（`internal/channel`）已接入后台与请求路由策略。
4. 请求字段诊断已闭环（事件 + runlog + 后台可视化）。

因此当前“必须要做”的重点已经从“功能是否存在”转为“生产化与迁移安全”。

## 2. 最新完成度判断

| 模块 | 当前状态 | 备注 |
|---|---|---|
| API 聚合分发中枢 | 75% | 核心能力有，生产持久化与运营能力待补 |
| Claude Code 转换 | 90% | 协议与流程闭环完成，记忆系统仍有补齐项 |
| 提智提效系统 | 85% | 调度、反思、工具链可用，策略运营能力待增强 |

## 3. 现在真正的 P0（必须完成）

### P0-1 状态持久化补齐

当前问题：

1. Auth/Token/Channel 默认内存实现，重启会丢失。

必须完成：

1. 接入持久化后端（文件或数据库）。
2. 启动恢复和数据迁移机制。
3. 备份与恢复脚本。

### P0-2 安全基线收敛

当前问题：

1. 默认管理员口令仍可能在开发配置中沿用到生产。

必须完成：

1. 部署前强校验（禁止默认口令）。
2. 最小权限 token 策略模板（模型、IP、额度）。
3. 管理操作审计与敏感字段脱敏规范。

### P0-3 灰度与回滚

当前问题：

1. 大规模迁移场景尚缺统一回归集与回滚演练记录。

必须完成：

1. 协议回归样本（Anthropic/OpenAI/CC）。
2. 关键边界用例（不支持字段、trailing JSON、stream/tool loop）。
3. 灰度监控阈值与回滚 SOP。

## 4. P1（重要但可后置）

1. 计费系统产品化：
   - `internal/costtrack` 接主程序管理面
   - 用户维度账单与预算阈值
2. 运营可观测：
   - 实时数据看板（请求量、消耗、错误率）
   - 告警通道（邮件/IM）
3. 记忆能力补完：
   - `SummarizeSession`/`ExtractKeyInfo` 实现
   - 长期记忆存储与检索策略

## 5. 迁移前检查清单

1. `go test ./... -count=1` 全绿。
2. 管理员口令已替换，权限模型已验证。
3. Auth/Token/Channel 持久化演练完成。
4. 请求解码诊断事件可在后台看到并可追溯到 runlog。
5. 灰度与回滚流程文档化并完成一次实操。
